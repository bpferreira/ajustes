name: Ajustes DiÃ¡rio

on:
  schedule:
    - cron: "30 8 * * 1-5"  # Executa Ã s 05:30 BRT (08:30 UTC), dias Ãºteis
  workflow_dispatch:         # Permite execuÃ§Ã£o manual via botÃ£o

jobs:
  baixar-ajustes:
    runs-on: ubuntu-latest
    container:
      image: bpferreira/ajustes:v1  # Imagem Docker com R e pacotes

    steps:
      - name: Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: Verificar estrutura inicial
        run: |
          echo "ğŸ“ Estrutura inicial:"
          ls -la
          echo "ğŸ“ ConteÃºdo de data/:"
          ls -la data/ || echo "Pasta data/ nÃ£o existe"
          echo "ğŸ“ ConteÃºdo de data/ajustes/:"
          ls -la data/ajustes/ || echo "Pasta data/ajustes/ nÃ£o existe"

      - name: Testar criaÃ§Ã£o de diretÃ³rios
        run: |
          echo "ğŸ§ª Testando criaÃ§Ã£o de diretÃ³rios..."
          Rscript R/teste_diretorios.R

      - name: Rodar baixar_b3.R com retry
        run: |
          for i in {1..10}; do
            echo "Tentativa $i para baixar B3..."
            Rscript R/baixar_b3.R && break
            sleep 5
          done

      - name: Verificar arquivos B3 apÃ³s download
        run: |
          echo "ğŸ“ Arquivos B3 apÃ³s download:"
          ls -la data/ajustes/b3/ || echo "Pasta B3 nÃ£o existe"

      - name: Rodar baixar_anbima.R com retry
        run: |
          for i in {1..10}; do
            echo "Tentativa $i para baixar ANBIMA..."
            Rscript R/baixar_anbima.R && break
            sleep 5
          done

      - name: Verificar arquivos ANBIMA apÃ³s download
        run: |
          echo "ğŸ“ Arquivos ANBIMA apÃ³s download:"
          ls -la data/ajustes/anbima/ || echo "Pasta ANBIMA nÃ£o existe"

      - name: Limpar arquivos antigos (+5 dias)
        run: |
          echo "ğŸ§¹ Limpando arquivos com mais de 5 dias..."
          find data/ajustes/b3 -name "*.csv" -type f -mtime +5 -print -delete
          find data/ajustes/anbima -name "*.csv" -type f -mtime +5 -print -delete

      - name: Verificar arquivos finais
        run: |
          echo "ğŸ“ Estrutura final dos dados:"
          find data/ajustes -type f -name "*.csv" -exec ls -la {} \;

      - name: Commit e push dos arquivos atualizados
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          echo "ğŸ“ Status do git antes do add:"
          git status
          echo "ğŸ“ Adicionando arquivos..."
          git add data/
          echo "ğŸ“ Status do git apÃ³s add:"
          git status
          echo "ğŸ“ Fazendo commit..."
          git commit -m "AtualizaÃ§Ã£o diÃ¡ria - $(date +'%Y-%m-%d')" || echo "Sem mudanÃ§as para commitar"
          echo "ğŸ“ Fazendo push..."
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
