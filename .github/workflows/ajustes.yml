name: Ajustes Di√°rio

on:
  schedule:
    - cron: "30 8 * * 1-5"  # Executa √†s 05:30 BRT (08:30 UTC), dias √∫teis
  workflow_dispatch:         # Permite execu√ß√£o manual via bot√£o

jobs:
  baixar-ajustes:
    runs-on: ubuntu-latest
    container:
      image: bpferreira/ajustes:v1  # Imagem Docker com R e pacotes

    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: Rodar baixar_b3.R com retry
        run: |
          for i in {1..10}; do
            echo "Tentativa $i para baixar B3..."
            Rscript R/baixar_b3.R && break
            sleep 5
          done

      - name: Rodar baixar_anbima.R com retry
        run: |
          for i in {1..10}; do
            echo "Tentativa $i para baixar ANBIMA..."
            Rscript R/baixar_anbima.R && break
            sleep 5
          done

      - name: Limpar arquivos antigos (+5 dias)
        run: |
          echo "üßπ Limpando arquivos com mais de 5 dias..."
          find data/ajustes/b3 -name "*.csv" -type f -mtime +5 -print -delete
          find data/ajustes/anbima -name "*.csv" -type f -mtime +5 -print -delete

      - name: Commit e push dos arquivos atualizados
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add data/
          git diff --cached --quiet || git commit -m "Atualiza√ß√£o di√°ria - $(date +'%Y-%m-%d')"
          git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" HEAD:main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
