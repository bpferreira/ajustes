name: Ajustes Diﾃ｡rio

on:
  schedule:
    - cron: "30 8 * * 1-5"  # 05:30 BRT (08:30 UTC) dias ﾃｺteis
  workflow_dispatch:

permissions:
  contents: write

jobs:
  baixar-ajustes:
    runs-on: ubuntu-latest
    container:
      image: bpferreira/ajustes:v1

    steps:
      - name: Checkout do repositﾃｳrio (sem cache)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Forﾃｧa fetch completo

      - name: Verificar versﾃ｣o atual (sem cache)
        run: |
          echo "剥 VERIFICAﾃﾃグ DE CACHE:"
          echo "套 Data/hora: $(date)"
          echo "搭 ﾃ嗟timo commit: $(git log -1 --oneline)"
          echo "搭 Commit hash: $(git rev-parse HEAD)"
          echo "刀 Conteﾃｺdo do workflow atual:"
          cat .github/workflows/ajustes.yml | head -10
          echo "笨 Verificaﾃｧﾃ｣o de cache concluﾃｭda"

      # <<< SOLUﾃﾃグ RADICAL: Configurar Git ANTES do checkout >>>
      - name: Configurar Git (SOLUﾃﾃグ RADICAL)
        run: |
          echo "肌 CONFIGURAﾃﾃグ RADICAL DO GIT..."
          
          # Estratﾃｩgia 1: Variﾃ｡vel de ambiente global
          export GIT_SAFE_DIRECTORY="*"
          echo "笨 GIT_SAFE_DIRECTORY=* configurado"
          
          # Estratﾃｩgia 2: Configurar Git em /tmp (fora de qualquer repo)
          cd /tmp
          git config --global --add safe.directory '*'
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "/_w/ajustes/ajustes"
          git config --global --add safe.directory "/github/workspace"
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          # Estratﾃｩgia 3: Verificar configuraﾃｧﾃ｣o
          echo "剥 Verificando configuraﾃｧﾃ｣o Git:"
          git config --global --list | grep safe.directory
          echo "笨 Configuraﾃｧﾃ｣o Git concluﾃｭda"

      - name: Verificar estrutura inicial
        run: |
          echo "刀 Estrutura inicial:"
          ls -la
          echo "刀 Conteﾃｺdo de data/:"
          ls -la data/ || echo "Pasta data/ nﾃ｣o existe"
          echo "刀 Conteﾃｺdo de data/ajustes/:"
          ls -la data/ajustes/ || echo "Pasta data/ajustes/ nﾃ｣o existe"

      - name: Executar diagnﾃｳstico completo
        run: |
          echo "剥 Executando diagnﾃｳstico completo..."
          Rscript R/diagnostico_completo.R

      - name: Rodar baixar_b3.R
        run: |
          echo "投 Executando baixar_b3.R..."
          Rscript R/baixar_b3.R
          echo "笨 baixar_b3.R concluﾃｭdo"

      - name: Rodar baixar_anbima.R
        run: |
          echo "投 Executando baixar_anbima.R..."
          Rscript R/baixar_anbima.R
          echo "笨 baixar_anbima.R concluﾃｭdo"

      - name: Verificar arquivos gerados
        run: |
          echo "刀 Verificando arquivos gerados:"
          echo "刀 Conteﾃｺdo de data/ajustes/:"
          ls -la data/ajustes/ || echo "Pasta data/ajustes/ nﾃ｣o existe"
          echo "刀 Conteﾃｺdo de data/ajustes/b3/:"
          ls -la data/ajustes/b3/ || echo "Pasta data/ajustes/b3/ nﾃ｣o existe"
          echo "刀 Conteﾃｺdo de data/ajustes/anbima/:"
          ls -la data/ajustes/anbima/ || echo "Pasta data/ajustes/anbima/ nﾃ｣o existe"

      - name: Pull com rebase (evitar conflitos)
        run: |
          git pull --rebase || true

      - name: Commit e push dos arquivos atualizados
        env:
          GIT_SAFE_DIRECTORY: "*"
        run: |
          echo "統 Preparando commit..."
          # Reforﾃｧo final do safe.directory
          git config --global --add safe.directory "$GITHUB_WORKSPACE" || true
          git config --global --add safe.directory "*" || true

          git add -A
          git status
          git commit -m "Atualizar dados de ajustes - $(date '+%Y-%m-%d')" || echo "Nenhuma mudanﾃｧa para commit"
          git push || echo "Nenhuma mudanﾃｧa para push"
