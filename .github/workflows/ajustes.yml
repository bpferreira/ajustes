name: Ajustes DiÃ¡rio

on:
  schedule:
    - cron: "30 8 * * 1-5"  # 05:30 BRT (08:30 UTC), dias Ãºteis
  workflow_dispatch:

permissions:
  contents: write

jobs:
  baixar-ajustes:
    runs-on: ubuntu-latest
    container:
      image: bpferreira/ajustes:v1

    steps:
      - name: Checkout do repositÃ³rio (forÃ§ar versÃ£o mais recente)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ForÃ§a fetch completo para evitar cache

      - name: Verificar versÃ£o atual (sem cache)
        run: |
          echo "ğŸ” VERIFICAÃ‡ÃƒO DE CACHE:"
          echo "ğŸ“… Data/hora: $(date)"
          echo "ğŸ“‹ Ãšltimo commit: $(git log -1 --oneline)"
          echo "ğŸ“‹ Commit hash: $(git rev-parse HEAD)"
          echo "ğŸ“ ConteÃºdo do workflow atual:"
          cat .github/workflows/ajustes.yml | head -10
          echo "âœ… VerificaÃ§Ã£o de cache concluÃ­da"

      # >>> PASSO CRÃTICO: configurar Git FORA do repo e marcar safe.directory no SYSTEM
      - name: Fix Git ownership (system-level safe.directory)
        working-directory: /
        run: |
          echo "Workspace: $GITHUB_WORKSPACE"
          git config --system --add safe.directory '*'
          git config --system --add safe.directory "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global user.name  "GitHub Action"
          git config --global user.email "action@github.com"
          echo "--- git config (origens) ---"
          git config --list --show-origin | grep -E 'safe\.directory|user\.name|user\.email' || true
          echo "âœ… Git configurado fora do repositÃ³rio"

      - name: Verificar estrutura inicial
        run: |
          echo "ğŸ“ Estrutura inicial:"
          ls -la
          echo "ğŸ“ ConteÃºdo de data/:"
          ls -la data/ || echo "Pasta data/ nÃ£o existe"
          echo "ğŸ“ ConteÃºdo de data/ajustes/:"
          ls -la data/ajustes/ || echo "Pasta data/ajustes/ nÃ£o existe"

      - name: Executar diagnÃ³stico de diretÃ³rios
        run: |
          echo "ğŸ” Executando diagnÃ³stico de diretÃ³rios..."
          Rscript R/diagnostico_diretorios.R

      - name: Rodar baixar_b3.R com retry
        run: |
          set -e
          for i in {1..5}; do
            echo "Tentativa {$i} para baixar B3..."
            if Rscript R/baixar_b3.R; then
              echo "âœ… baixar_b3.R concluÃ­do"
              break
            fi
            echo "âŒ Falha. Aguardando e tentando novamente..."
            sleep 10
          done

      - name: Rodar baixar_anbima.R com retry
        run: |
          set -e
          for i in {1..5}; do
            echo "Tentativa {$i} para baixar ANBIMA..."
            if Rscript R/baixar_anbima.R; then
              echo "âœ… baixar_anbima.R concluÃ­do"
              break
            fi
            echo "âŒ Falha. Aguardando e tentando novamente..."
            sleep 10
          done

      - name: Limpar arquivos antigos (+5 dias)
        run: |
          echo "ğŸ§¹ Limpando CSV antigos com mais de 5 dias em data/ajustes/**"
          find data/ajustes -type f -name "*.csv" -mtime +5 -print -delete || true

      - name: Verificar arquivos gerados
        run: |
          echo "ğŸ“ ConteÃºdo de data/ajustes/:"
          ls -la data/ajustes/ || echo "Pasta data/ajustes/ nÃ£o existe"
          echo "ğŸ“ ConteÃºdo de data/ajustes/b3/:"
          ls -la data/ajustes/b3/ || echo "Pasta data/ajustes/b3/ nÃ£o existe"
          echo "ğŸ“ ConteÃºdo de data/ajustes/anbima/:"
          ls -la data/ajustes/anbima/ || echo "Pasta data/ajustes/anbima/ nÃ£o existe"

      - name: Pull com rebase (evitar conflitos)
        run: git pull --rebase || true

      # âš ï¸ NADA de `git config` aqui. Apenas add/commit/push.
      - name: Commit e push dos arquivos atualizados
        run: |
          echo "ğŸ“ Preparando commit..."
          git add -A
          git status
          git commit -m "Atualizar dados de ajustes - $(date '+%Y-%m-%d')" || echo "Nenhuma mudanÃ§a para commit"
          git push || echo "Nenhuma mudanÃ§a para push"
