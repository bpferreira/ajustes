name: Ajustes Di√°rio (debug)

on:
  workflow_dispatch:

permissions:
  contents: write

defaults:
  run:
    shell: bash
    working-directory: ${{ github.workspace }}

jobs:
  baixar-ajustes:
    runs-on: ubuntu-latest
    container:
      image: bpferreira/ajustes:v1

    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: Fix Git ownership (system-level safe.directory)
        working-directory: /
        run: |
          git config --system --add safe.directory '*'
          git config --system --add safe.directory "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global user.name  "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Echo env e diret√≥rios
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          echo "PWD (bash)="; pwd
          echo "Listando raiz do repo:"; ls -la
          echo "R getwd():"; Rscript -e 'cat(getwd(), "\n")'
          Rscript -e 'sessionInfo()'

      - name: Verificar se scripts t√™m bloco XLSX
        run: |
          echo ">> baixar_b3.R:"
          nl -ba R/baixar_b3.R | sed -n '1,400p' | grep -nE 'openxlsx|createWorkbook|saveWorkbook|writeDataTable' || echo "(n√£o encontrou fun√ß√µes XLSX no baixar_b3.R)"
          echo ">> baixar_anbima.R:"
          nl -ba R/baixar_anbima.R | sed -n '1,400p' | grep -nE 'openxlsx|createWorkbook|saveWorkbook|writeDataTable' || echo "(n√£o encontrou fun√ß√µes XLSX no baixar_anbima.R)"

      - name: Garantir pastas de sa√≠da
        run: |
          mkdir -p data/ajustes/b3
          mkdir -p data/ajustes/anbima
          ls -la data/ajustes || true

      # SISTEMA: toolchain e libs para compilar/rodar pacotes R nativos
      - name: Instalar toolchain e libs do sistema
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            build-essential libcurl4-openssl-dev libssl-dev libxml2-dev \
            zlib1g-dev libbz2-dev liblzma-dev libzstd-dev
          apt-get clean
          rm -rf /var/lib/apt/lists/*

      # R: instalar pacotes necess√°rios
      - name: Instalar pacotes R (readxl, openxlsx, writexl)
        run: |
          Rscript -e 'pkgs <- c("readxl","openxlsx","writexl"); \
                      need <- setdiff(pkgs, rownames(installed.packages())); \
                      if(length(need)) install.packages(need, repos="https://cloud.r-project.org"); \
                      cat("Vers√µes -> openxlsx:", as.character(packageVersion("openxlsx")), \
                          " readxl:", as.character(packageVersion("readxl")), \
                          " writexl:", as.character(packageVersion("writexl")), "\n")'

      # Smoke test: criar um XLSX simples
      - name: Teste openxlsx (deve criar data/ajustes/test_xlsx.xlsx)
        run: |
          Rscript -e 'suppressPackageStartupMessages(library(openxlsx)); \
                      dir.create("data/ajustes", showWarnings=FALSE, recursive=TRUE); \
                      wb <- createWorkbook(); addWorksheet(wb,"Sheet1"); \
                      writeData(wb,"Sheet1", data.frame(ok=1:3)); \
                      saveWorkbook(wb, "data/ajustes/test_xlsx.xlsx", overwrite=TRUE); \
                      cat("file.exists:", file.exists("data/ajustes/test_xlsx.xlsx"), "\n")'
          echo "üìÇ Ap√≥s teste openxlsx:"; ls -la data/ajustes || true
          test -f data/ajustes/test_xlsx.xlsx || (echo "‚ùå Falha ao criar XLSX de teste (openxlsx/perm)" && exit 1)

      - name: Rodar baixar_b3.R (for√ßando wd)
        run: |
          set -e
          echo "R getwd() antes do script:"; Rscript -e 'cat(getwd(), "\n")'
          Rscript -e 'options(error=function(){traceback(2); q(status=1)}); \
                      setwd(Sys.getenv("GITHUB_WORKSPACE")); \
                      source("R/baixar_b3.R")'
          echo "üìÇ data/ajustes/b3:"; ls -la data/ajustes/b3 || true
          echo "üîé Arquivos b3:"; (ls -1 data/ajustes/b3/* 2>/dev/null || true)
          # Asserts
          test -n "$(ls -1 data/ajustes/b3/*.csv 2>/dev/null)" || (echo "‚ùå CSV da B3 n√£o gerado" && exit 1)
          test -n "$(ls -1 data/ajustes/b3/*.xlsx 2>/dev/null || ls -1 data/ajustes/b3/*.xls 2>/dev/null)" || (echo "‚ùå XLSX/XLS da B3 n√£o gerado" && exit 1)

      - name: Rodar baixar_anbima.R (for√ßando wd)
        run: |
          set -e
          echo "R getwd() antes do script:"; Rscript -e 'cat(getwd(), "\n")'
          Rscript -e 'options(error=function(){traceback(2); q(status=1)}); \
                      setwd(Sys.getenv("GITHUB_WORKSPACE")); \
                      source("R/baixar_anbima.R")'
          echo "üìÇ data/ajustes/anbima:"; ls -la data/ajustes/anbima || true
          echo "üîé Arquivos anbima:"; (ls -1 data/ajustes/anbima/* 2>/dev/null || true)
          # Asserts
          test -n "$(ls -1 data/ajustes/anbima/*.csv 2>/dev/null)" || (echo "‚ùå CSV da ANBIMA n√£o gerado" && exit 1)
          test -n "$(ls -1 data/ajustes/anbima/*.xlsx 2>/dev/null || ls -1 data/ajustes/anbima/*.xls 2>/dev/null)" || (echo "‚ùå XLSX/XLS da ANBIMA n√£o gerado" && exit 1)

      - name: Varredura ‚Äî procurar arquivos gerados no workspace
        run: |
          echo "üîé Procurando .csv/.xls/.xlsx no workspace..."
          find "$GITHUB_WORKSPACE" -type f \( -name "*.csv" -o -name "*.xls" -o -name "*.xlsx" \) -printf '%TY-%Tm-%Td %TT %p\n' | sort || true

      - name: Status do repo (antes do commit)
        run: git status

      - name: Commit e push dos arquivos atualizados
        run: |
          echo "üìù Preparando commit..."
          git add -f data/ajustes/**/*.csv data/ajustes/**/*.xlsx data/ajustes/**/*.xls || true
          git status
          git commit -m "Atualizar ajustes B3/ANBIMA - $(date '+%Y-%m-%d %H:%M:%S')" || echo "Nenhuma mudan√ßa para commit"
          git push || echo "Nenhuma mudan√ßa para push"
