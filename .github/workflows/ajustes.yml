name: Ajustes Di√°rio (debug)

on:
  workflow_dispatch:

permissions:
  contents: write

defaults:
  run:
    shell: bash
    working-directory: ${{ github.workspace }}

jobs:
  baixar-ajustes:
    runs-on: ubuntu-latest
    container:
      image: bpferreira/ajustes:v1

    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: Fix Git ownership (system-level safe.directory)
        working-directory: /
        run: |
          git config --system --add safe.directory '*'
          git config --system --add safe.directory "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global user.name  "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Echo env e diret√≥rios
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          echo "PWD (bash)="; pwd
          echo "Listando raiz do repo:"; ls -la
          echo "R getwd():"; Rscript -e 'cat(getwd(), "\n")'

      - name: Garantir pastas de sa√≠da
        run: |
          mkdir -p data/ajustes/b3
          mkdir -p data/ajustes/anbima
          ls -la data/ajustes || true

      - name: Rodar baixar_b3.R (for√ßando wd)
        run: |
          echo "R getwd() antes do script:"; Rscript -e 'cat(getwd(), "\n")'
          Rscript -e 'setwd(Sys.getenv("GITHUB_WORKSPACE")); source("R/baixar_b3.R")'
          echo "üìÇ Ap√≥s baixar_b3.R, conte√∫do data/ajustes/b3:"; ls -la data/ajustes/b3 || true

      - name: Rodar baixar_anbima.R (for√ßando wd)
        run: |
          echo "R getwd() antes do script:"; Rscript -e 'cat(getwd(), "\n")'
          Rscript -e 'setwd(Sys.getenv("GITHUB_WORKSPACE")); source("R/baixar_anbima.R")'
          echo "üìÇ Ap√≥s baixar_anbima.R, conte√∫do data/ajustes/anbima:"; ls -la data/ajustes/anbima || true

      - name: Varredura ‚Äî procurar arquivos gerados no workspace
        run: |
          echo "üîé Procurando .csv/.xls no workspace..."
          find "$GITHUB_WORKSPACE" -type f \( -name "*.csv" -o -name "*.xls" \) -printf '%TY-%Tm-%Td %TT %p\n' | sort || true

      - name: Varredura ampla ‚Äî se salvou fora do workspace
        run: |
          echo "üîé Procurando .csv/.xls fora tamb√©m (limitado)..."
          find / -maxdepth 4 -type f \( -name "*.csv" -o -name "*.xls" \) 2>/dev/null | grep -E '/(ajustes|anbima|b3)/' || true

      - name: Checar se o Git est√° ignorando algo
        run: |
          echo "Conte√∫do do .gitignore (se houver):"
          [ -f .gitignore ] && cat .gitignore || echo "(sem .gitignore)"
          echo "--- git check-ignore ---"
          git check-ignore -v data/ajustes/* data/ajustes/b3/* data/ajustes/anbima/* || echo "Nada ignorado"

      - name: Status do repo
        run: |
          git status
