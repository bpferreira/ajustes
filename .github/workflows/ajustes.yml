name: Ajustes DiÃ¡rio

on:
  schedule:
    - cron: "30 8 * * 1-5"  # Executa Ã s 05:30 BRT (08:30 UTC), dias Ãºteis
  workflow_dispatch:         # Permite execuÃ§Ã£o manual via botÃ£o

jobs:
  baixar-ajustes:
    runs-on: ubuntu-latest
    container:
      image: bpferreira/ajustes:v1  # Imagem Docker com R e pacotes

    steps:
      - name: Checkout do repositÃ³rio (forÃ§ar versÃ£o mais recente)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # ForÃ§a fetch completo para evitar cache

      - name: Verificar versÃ£o do workflow
        run: |
          echo "ğŸ” Verificando versÃ£o atual do workflow..."
          echo "ğŸ“… Data/hora atual: $(date)"
          echo "ğŸ“‹ Ãšltimo commit: $(git log -1 --oneline)"
          echo "ğŸ“ ConteÃºdo do workflow:"
          cat .github/workflows/ajustes.yml | head -20

      - name: Configurar Git para GitHub Actions
        env:
          GIT_SAFE_DIRECTORY: /_w/ajustes/ajustes
        run: |
          echo "ğŸ”§ Configurando Git para resolver 'dubious ownership'..."
          echo "ğŸ“ DiretÃ³rio atual: $(pwd)"
          echo "ğŸ”’ Configurando safe.directory via variÃ¡vel de ambiente..."
          
          # EstratÃ©gia 1: VariÃ¡vel de ambiente
          export GIT_SAFE_DIRECTORY="/_w/ajustes/ajustes:/github/workspace:."
          
          # EstratÃ©gia 2: ConfiguraÃ§Ã£o global ANTES de qualquer comando Git
          git config --global --add safe.directory /_w/ajustes/ajustes
          git config --global --add safe.directory /github/workspace
          git config --global --add safe.directory /__w/ajustes/ajustes
          git config --global --add safe.directory .
          git config --global --add safe.directory /_w/ajustes
          
          # EstratÃ©gia 3: Configurar usuÃ¡rio APÃ“S safe.directory
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          echo "âœ… Git configurado com mÃºltiplas estratÃ©gias de seguranÃ§a"

      - name: Verificar estrutura inicial
        run: |
          echo "ğŸ“ Estrutura inicial:"
          ls -la
          echo "ğŸ“ ConteÃºdo de data/:"
          ls -la data/ || echo "Pasta data/ nÃ£o existe"
          echo "ğŸ“ ConteÃºdo de data/ajustes/:"
          ls -la data/ajustes/ || echo "Pasta data/ajustes/ nÃ£o existe"

      - name: Executar diagnÃ³stico completo
        run: |
          echo "ğŸ” Executando diagnÃ³stico completo..."
          Rscript R/diagnostico_completo.R

      - name: Rodar baixar_b3.R
        run: |
          echo "ğŸ“Š Executando baixar_b3.R..."
          Rscript R/baixar_b3.R
          echo "âœ… baixar_b3.R concluÃ­do"

      - name: Rodar baixar_anbima.R
        run: |
          echo "ğŸ“Š Executando baixar_anbima.R..."
          Rscript R/baixar_anbima.R
          echo "âœ… baixar_anbima.R concluÃ­do"

      - name: Verificar arquivos gerados
        run: |
          echo "ğŸ“ Verificando arquivos gerados:"
          echo "ğŸ“ ConteÃºdo de data/ajustes/:"
          ls -la data/ajustes/ || echo "Pasta data/ajustes/ nÃ£o existe"
          echo "ğŸ“ ConteÃºdo de data/ajustes/b3/:"
          ls -la data/ajustes/b3/ || echo "Pasta data/ajustes/b3/ nÃ£o existe"
          echo "ğŸ“ ConteÃºdo de data/ajustes/anbima/:"
          ls -la data/ajustes/anbima/ || echo "Pasta data/ajustes/anbima/ nÃ£o existe"

      - name: Commit e push dos arquivos atualizados
        env:
          GIT_SAFE_DIRECTORY: /_w/ajustes/ajustes
        run: |
          echo "ğŸ“ Preparando commit..."
          git add .
          git status
          git commit -m "Atualizar dados de ajustes - $(date '+%Y-%m-%d')" || echo "Nenhuma mudanÃ§a para commit"
          git push || echo "Nenhuma mudanÃ§a para push"
