name: Ajustes Di√°rio (debug)

on:
  workflow_dispatch:

permissions:
  contents: write

defaults:
  run:
    shell: bash
    working-directory: ${{ github.workspace }}

jobs:
  baixar-ajustes:
    runs-on: ubuntu-latest
    container:
      image: bpferreira/ajustes:v1

    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: Fix Git ownership (system-level safe.directory)
        working-directory: /
        run: |
          git config --system --add safe.directory '*'
          git config --system --add safe.directory "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global user.name  "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Echo env e diret√≥rios
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          echo "PWD (bash)="; pwd
          echo "Listando raiz do repo:"; ls -la
          echo "R getwd():"; Rscript -e 'cat(getwd(), "\n")'

      - name: Garantir pastas de sa√≠da
        run: |
          mkdir -p data/ajustes/b3
          mkdir -p data/ajustes/anbima
          ls -la data/ajustes || true

      # Instalar pacotes que os scripts usam para gerar XLSX
      - name: Instalar pacotes extras (readxl, openxlsx)
        run: |
          Rscript -e 'pkgs <- c("readxl","openxlsx"); \
                      ins <- setdiff(pkgs, rownames(installed.packages())); \
                      if(length(ins)) install.packages(ins, repos="https://cloud.r-project.org")'

      # üëá Passo de diagn√≥stico: testa o openxlsx salvando um arquivo dummy
      - name: Teste openxlsx (deve criar data/ajustes/test_xlsx.xlsx)
        run: |
          Rscript -e 'suppressPackageStartupMessages(library(openxlsx)); \
                      dir.create("data/ajustes", showWarnings=FALSE, recursive=TRUE); \
                      wb <- createWorkbook(); addWorksheet(wb,"Sheet1"); \
                      writeData(wb,"Sheet1", data.frame(ok=1:3)); \
                      saveWorkbook(wb, "data/ajustes/test_xlsx.xlsx", overwrite=TRUE); \
                      cat("file.exists:", file.exists("data/ajustes/test_xlsx.xlsx"), "\n")'
          echo "üìÇ Ap√≥s teste openxlsx:"; ls -la data/ajustes || true
          test -f data/ajustes/test_xlsx.xlsx || (echo "‚ùå Falha ao criar XLSX de teste (openxlsx/perm)" && exit 1)

      - name: Rodar baixar_b3.R (for√ßando wd)
        run: |
          set -e
          echo "R getwd() antes do script:"; Rscript -e 'cat(getwd(), "\n")'
          Rscript -e 'options(error=function(){traceback(2); q(status=1)}); \
                      setwd(Sys.getenv("GITHUB_WORKSPACE")); \
                      source("R/baixar_b3.R")'
          echo "üìÇ Ap√≥s baixar_b3.R, conte√∫do data/ajustes/b3:"; ls -la data/ajustes/b3 || true
          echo "üîé Arquivos encontrados em b3:"
          (ls -1 data/ajustes/b3/* 2>/dev/null || true)
          # Asserts
          test -n "$(ls -1 data/ajustes/b3/*.csv 2>/dev/null)" || (echo "‚ùå CSV da B3 n√£o gerado" && exit 1)
          test -n "$(ls -1 data/ajustes/b3/*.xlsx 2>/dev/null || ls -1 data/ajustes/b3/*.xls 2>/dev/null)" || (echo "‚ùå XLSX/XLS da B3 n√£o gerado" && exit 1)

      - name: Rodar baixar_anbima.R (for√ßando wd)
        run: |
          set -e
          echo "R getwd() antes do script:"; Rscript -e 'cat(getwd(), "\n")'
          Rscript -e 'options(error=function(){traceback(2); q(status=1)}); \
                      setwd(Sys.getenv("GITHUB_WORKSPACE")); \
                      source("R/baixar_anbima.R")'
          echo "üìÇ Ap√≥s baixar_anbima.R, conte√∫do data/ajustes/anbima:"; ls -la data/ajustes/anbima || true
          echo "üîé Arquivos encontrados em anbima:"
          (ls -1 data/ajustes/anbima/* 2>/dev/null || true)
          # Asserts
          test -n "$(ls -1 data/ajustes/anbima/*.csv 2>/dev/null)" || (echo "‚ùå CSV da ANBIMA n√£o gerad*
