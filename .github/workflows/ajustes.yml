name: Ajustes Diário

on:
  schedule:
    - cron: "30 8 * * 1-5"  # Executa às 05:30 BRT (08:30 UTC), dias úteis
  workflow_dispatch:         # Permite execução manual via botão

permissions:
  contents: write

jobs:
  baixar-ajustes:
    runs-on: ubuntu-latest
    container:
      image: bpferreira/ajustes:v1  # Imagem Docker com R e pacotes

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Git (safe.directory + user)
        run: |
          echo "🔧 Configurando Git para resolver 'dubious ownership'..."
          git config --global  --add safe.directory "$GITHUB_WORKSPACE" || true
          git config --system  --add safe.directory "$GITHUB_WORKSPACE" || true
          git config --global user.name  "GitHub Action"
          git config --global user.email "action@github.com"
          echo "✅ Git configurado com safe.directory"

      - name: Verificar estrutura inicial
        run: |
          echo "📁 Estrutura inicial:"
          ls -la
          echo "📁 Conteúdo de data/:"
          ls -la data/ || echo "Pasta data/ não existe"
          echo "📁 Conteúdo de data/ajustes/:"
          ls -la data/ajustes/ || echo "Pasta data/ajustes/ não existe"

      - name: Executar diagnóstico completo
        run: |
          echo "🔍 Executando diagnóstico completo..."
          Rscript R/diagnostico_completo.R

      - name: Rodar baixar_b3.R
        run: |
          echo "📊 Executando baixar_b3.R..."
          Rscript R/baixar_b3.R
          echo "✅ baixar_b3.R concluído"

      - name: Rodar baixar_anbima.R
        run: |
          echo "📊 Executando baixar_anbima.R..."
          Rscript R/baixar_anbima.R
          echo "✅ baixar_anbima.R concluído"

      - name: Verificar arquivos gerados
        run: |
          echo "📁 Verificando arquivos gerados:"
          echo "📁 Conteúdo de data/ajustes/:"
          ls -la data/ajustes/ || echo "Pasta data/ajustes/ não existe"
          echo "📁 Conteúdo de data/ajustes/b3/:"
          ls -la data/ajustes/b3/ || echo "Pasta data/ajustes/b3/ não existe"
          echo "📁 Conteúdo de data/ajustes/anbima/:"
          ls -la data/ajustes/anbima/ || echo "Pasta data/ajustes/anbima/ não existe"

      - name: Pull com rebase (evitar conflitos)
        run: |
          git pull --rebase || true

      - name: Commit e push dos arquivos atualizados
        run: |
          echo "📝 Preparando commit..."
          git add .
          git status
          git commit -m "Atualizar dados de ajustes - $(date '+%Y-%m-%d')" || echo "Nenhuma mudança para commit"
          git push || echo "Nenhuma mudança para push"
